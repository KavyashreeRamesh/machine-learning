---
title: "Decision Trees"
author: "Kathirmani Sukumar"
date: "May 2, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tree)
```

```{r}
adv = read.csv('e:/ml/Advertising.csv')

model_tree = tree(sales~TV+radio+newspaper, data=adv)
{{plot(model_tree)
  text(model_tree)}}
sort(adv$TV)
```

```{r}

adv_temp = adv
cuts = c()
mses = c()

TV_uniqs = sort(unique(adv_temp$TV))
for (i in seq(1, length(TV_uniqs)-1)){
  curr_cut = (TV_uniqs[i] + TV_uniqs[i+1]) / 2
  cuts = c(cuts, curr_cut)
  samples_left = adv_temp %>% filter(TV<curr_cut)
  samples_right = adv_temp %>% filter(TV>curr_cut)
  avg_left = mean(samples_left$sales)
  avg_right = mean(samples_right$sales)
  adv_temp$predicted_sales = if_else(adv_temp$TV<curr_cut, avg_left, avg_right)
  curr_mse = sum((adv_temp$sales-adv_temp$predicted_sales)^2)/nrow(adv_temp)
  mses = c(mses, curr_mse)
}
models_perf = data.frame(TV_cut=cuts,MSE=mses )
models_perf %>% arrange(MSE) %>% head(1)

adv %>% filter(TV < 30.05) %>% summarise(mean(sales))
```

### Decision Trees with more than one input predictor
```{r}
adv = read.csv('e:/ml/Advertising.csv')
model = tree(sales~., data=adv)
{{plot(model)
  text(model)}}
```
```{r}
TV_uniqs = sort(unique(adv$TV))
radio_uniqs = sort(unique(adv$radio))
newspaper_uniqs = sort(unique(adv$newspaper))



cuts_tv = (TV_uniqs[1:length(TV_uniqs)-1] + TV_uniqs[2:length(TV_uniqs)])/2
length(cuts_tv)
cuts_radio = (radio_uniqs[1:length(radio_uniqs)-1] + radio_uniqs[2:length(radio_uniqs)])/2
cuts_newspaper = (newspaper_uniqs[1:length(newspaper_uniqs)-1] +newspaper_uniqs[2:length(newspaper_uniqs)])/2

## Method 1

library(dplyr)
temp = adv %>% filter(TV >122.05 )
nrow(temp)
tv_cuts_mse = c()
for (cut in cuts_tv){
  samples_left = temp %>% filter(TV<cut)  
  samples_right = temp %>% filter(TV>cut)
  pred_left = mean(samples_left$sales)
  pred_right = mean(samples_right$sales)
  temp$pred = ifelse(temp$TV<cut, pred_left, pred_right)
  curr_mse = sum((temp$sales-temp$pred)^2)/nrow(temp)
  tv_cuts_mse = c(tv_cuts_mse, curr_mse)
}

radio_cuts_mse = c()
for (cut in cuts_radio){
  samples_left = temp %>% filter(radio<cut)  
  samples_right = temp %>% filter(radio>cut)
  pred_left = mean(samples_left$sales)
  pred_right = mean(samples_right$sales)
  temp$pred = ifelse(temp$radio<cut, pred_left, pred_right)
  curr_mse = sum((temp$sales-temp$pred)^2)/nrow(temp)
  radio_cuts_mse = c(radio_cuts_mse, curr_mse)
}
newspaper_cuts_mse = c()
for (cut in cuts_newspaper){
  samples_left = temp %>% filter(newspaper<cut)  
  samples_right = temp %>% filter(newspaper>cut)
  pred_left = mean(samples_left$sales)
  pred_right = mean(samples_right$sales)
  temp$pred = ifelse(temp$newspaper<cut, pred_left, pred_right)
  curr_mse = sum((temp$sales-temp$pred)^2)/nrow(temp)
  newspaper_cuts_mse = c(newspaper_cuts_mse, curr_mse)
}


result_TV = data.frame(column=rep('TV', length(cuts_tv)),
                                  cut=cuts_tv,
                                  mse=tv_cuts_mse)

result_radio = data.frame(column=rep('radio', length(cuts_radio)),
                                  cut=cuts_radio,
                                  mse=radio_cuts_mse)

result_newspaper = data.frame(column=rep('newspaper', length(cuts_newspaper)),
                                  cut=cuts_newspaper,
                                  mse=newspaper_cuts_mse)

result = rbind(result_TV, result_radio, result_newspaper)
View(result)
nrow(result)

result %>% arrange(mse) %>% head(1)

nrow(adv %>% filter(TV<122.05))

## Method 2
cuts = c(cuts_tv, cuts_radio, cuts_newspaper)
predictors = c(rep('TV', length(cuts_tv)), rep('radio', length(cuts_radio)),
               rep('newspaper', length(cuts_newspaper)))
result = data.frame(cut=cuts, predictor=predictors)
cuts_mse = c()

temp = adv
for (i in seq(1, length(cuts))){
  cut = cuts[i]
  curr_col = predictors[i]
  samples_left = temp[temp[, curr_col]<cut,]  
  samples_right = temp[temp[, curr_col]>cut,]
  pred_left = mean(samples_left$sales)
  pred_right = mean(samples_right$sales)
  temp$pred = ifelse(temp[,curr_col]<cut, pred_left, pred_right)
  curr_mse = sum((temp$sales-temp$pred)^2)/nrow(temp)
  cuts_mse = c(cuts_mse, curr_mse)
}
result$mse = cuts_mse
View(result)
result %>% arrange(mse) %>% head(1)
```

```{r}
View(temp[, curr_col]<cut)
```

